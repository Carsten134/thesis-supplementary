---
title: "Application Master Thesis"
author: "Carsten Stahl"
date: "2025-12-02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rspsp)
library(gstat)
library(sf)
```

## Loading the data
We will load the preprocessed data from the CDS:
```{r}
setwd("D:/Daten/DataScienceMaster/Semester 4/Masterarbeit/master-application")
pre_ind_wet_hour <- data.matrix(read.csv("./data/processed/pre_ind_wet_hours.csv", header=FALSE))
pre_ind_pot <- data.matrix(read.csv("./data/processed/pre_pot_mean.csv", header=FALSE))
post_ind_wet_hour <- data.matrix(read.csv("./data/processed/post_ind_wet_hours.csv", header=FALSE))
post_ind_pot <- data.matrix(read.csv("./data/processed/post_pot_mean.csv", header=FALSE))


pre_ind_wet_hour_sf <- read_sf("./data/processed/pre_wet_hours.gpkg")
pre_ind_pot_sf <- read_sf("./data/processed/pre_pot.gpkg")
post_ind_wet_hour_sf <- read_sf("./data/processed/post_wet_hours.gpkg")
post_ind_pot_sf <- read_sf("./data/processed/post_pot.gpkg")

```


Looking at the samples + centering the data:
```{r}
# demeaning in order to not make 0 freq. dominate
pre_ind_pot <- pre_ind_pot - mean(pre_ind_pot)
pre_ind_wet_hour <- pre_ind_wet_hour - mean(pre_ind_wet_hour)

post_ind_pot <- post_ind_pot - mean(post_ind_pot)
post_ind_wet_hour <- post_ind_wet_hour - mean(post_ind_wet_hour)


image(pre_ind_pot)
image(pre_ind_wet_hour)

image(post_ind_pot)
image(post_ind_wet_hour)
```
## Checking Stationarity
```{r}
post_wh_v <- variogram(tp ~ 1, post_ind_wet_hour_sf)
post_pot_v <- variogram(tp ~ 1, post_ind_pot_sf)
pre_wh_v <- variogram(tp ~ 1, pre_ind_wet_hour_sf)
pre_pot_v <- variogram(tp ~ 1, pre_ind_pot_sf)
pre_pot_v_fix <- variogram(tp ~ latitude + longitude, pre_ind_pot_sf)
post_pot_v_fix <- variogram(tp ~ latitude + longitude, post_ind_pot_sf)


plot(gamma ~ dist, data = pre_wh_v, 
     type = "b", 
     lwd = 1.5, 
     cex = 1.1, 
     col = "red",
     xlab = "Distance", 
     ylab = "Semivariance")
plot(gamma ~ dist, data = pre_pot_v, 
     type = "b", 
     lwd = 1.5, 
     cex = 1.1, 
     col = "red",
     xlab = "Distance", 
     ylab = "Semivariance")
plot(gamma ~ dist, data = pre_pot_v_fix, 
     type = "b", 
     lwd = 1.5, 
     cex = 1.1, 
     col = "red",
     xlab = "Distance", 
     ylab = "Semivariance")

plot(gamma ~ dist, data = post_wh_v, 
     type = "b", 
     lwd = 1.5, 
     cex = 1.1, 
     col = "red",
     xlab = "Distance", 
     ylab = "Semivariance")
plot(gamma ~ dist, data = post_pot_v, 
     type = "b", 
     lwd = 1.5, 
     cex = 1.1, 
     col = "red",
     xlab = "Distance", 
     ylab = "Semivariance")
plot(gamma ~ dist, data = post_pot_v_fix, 
     type = "b", 
     lwd = 1.5, 
     cex = 1.1, 
     col = "red",
     xlab = "Distance", 
     ylab = "Semivariance")


class(pre_wh_v)
```

wet hour seems fine, but POT is suggests trending behavior. We need to adjust this with universal kriging.

### Kriging POT
We will try to fix the trending behavior observed in the semivariogram of the POT lattices by fitting universal kriging.
```{r}
uk_formula <- tp ~ poly(latitude,1, raw=T) + poly(longitude, 5, raw=T) + 1
trend_lm <- lm(uk_formula, data = post_ind_pot_sf)
post_ind_pot_sf$residuals <- residuals(trend_lm)

post_ind_pot_sf$pred <- predict(trend_lm)

plot(post_ind_pot_sf)
plot(variogram(residuals ~ 1, post_ind_pot_sf))
summary(trend_lm)
```


## looking at spectrum
```{r}
library(ggplot2)
library(reshape2)
library(latex2exp)

plot_spatial_periodogram <- function(mat, 
                                     title = "Spatial Periodogram", 
                                     log_scale = TRUE, 
                                     center_freq = TRUE) {
  
  # 1. Handle Log transformation (common for spectra)
  if (log_scale) {
    # Adding a small constant to avoid log(0) if necessary
    mat <- log10(mat + 1e-10)
    legend_label <- "Log10(Power)"
  } else {
    legend_label <- "Amplitude"
  }
  
  # 2. Handle Frequency Centering (shifting 0 frequency to center)
  # R's standard FFT puts frequency 0 at index 1. 
  # "Centering" moves it to the middle of the plot.
  if (center_freq) {
    # Swap quadrants
    r <- nrow(mat)
    c <- ncol(mat)
    r_half <- ceiling(r/2)
    c_half <- ceiling(c/2)
  
    
    # Define centered frequency axis (-0.5 to 0.5)
    freq_x <- seq(-0.5, 0.5, length.out = nrow(mat))
    freq_y <- seq(-0.5, 0.5, length.out = ncol(mat))
    
  } else {
    # Define standard frequency axis (0 to 1)
    freq_x <- seq(0, 1, length.out = nrow(mat))
    freq_y <- seq(0, 1, length.out = ncol(mat))
  }
  
  # 3. Transform to Long Format for ggplot
  # Assign row/col names to our frequency vectors so melt picks them up
  rownames(mat) <- freq_x
  colnames(mat) <- freq_y
  
  df <- reshape2::melt(mat)
  colnames(df) <- c("Freq_X", "Freq_Y", "Value")
  
  # 4. Plot
  p <- ggplot(df, aes(x = Freq_X, y = Freq_Y, fill = Value)) +
    geom_raster() + # geom_raster is faster than geom_tile for dense grids
    scale_fill_viridis_c(name = legend_label) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    labs(
      title = title,
      x = TeX(r"{$\omega_1$}"),
      y = TeX(r"{$\omega_2$}")
    ) +
    theme_minimal() +
    theme(
      panel.grid = element_blank(),
      aspect.ratio = 1 # Force square plot typically desirable for spatial data
    )
  
  return(p)
}

# plot_spatial_periodogram(I(pre_ind_pot), "", F)
plot_spatial_periodogram(I(pre_ind_wet_hour), "", F)

# plot_spatial_periodogram(I(post_ind_pot), "", F)
plot_spatial_periodogram(I(post_ind_wet_hour), "", F)
```


Testing
```{r}
# finding the bandwidth
dims <- dim(pre_ind_wet_hour)
N <- dims[1]; M <- dims[2]
h <- (N * M )^(-.3333)

h

cat("\n")
# applying varphi_n^* 
test.spectral(pre_ind_wet_hour, post_ind_wet_hour, 300, .05, h1=h, h2=h)
cat("\n")
test.spectral(pre_ind_wet_hour, post_ind_wet_hour, 300, .05, h1=.12, h2=.12)
cat("\n")
# applying varphi_n^p
pt3(pre_ind_wet_hour, post_ind_wet_hour, .05)
```
```{r}
# testing weak isotropy
test.spectral(pre_ind_wet_hour, NULL, 300, .05, "isotropy", h1=h, h2=h)
cat("\n")
test.spectral(post_ind_wet_hour, NULL, 300, .05, "isotropy", h1=h, h2=h)
cat("\n")
test.spectral(pre_ind_pot, NULL, 300, .05, "isotropy", h1=h, h2=h)
```
Looking more into the pre_ind_pot value
```{r}
plot(test.spectral(pre_ind_pot, NULL, 300, .05, "isotropy", h1=h, h2=h))
```
```{r}
plot_spatial_periodogram(I(pre_ind_pot), "", F)
```


```{r}
# application of weak stationarity
h = (N*M)^(-.2)
phi_n_stnry(pre_ind_wet_hour, 300, .05, h1=h, h2=h)
cat("\n")
phi_n_stnry(pre_ind_pot, 300, .05, h1=h, h2=h)
cat("\n")
phi_n_stnry(post_ind_wet_hour, 300, .05, h1=h, h2=h)
cat("\n")
phi_n_stnry(post_ind_pot, 300, .05, h1=h, h2=h)
```

The wet hour average does not seem to differ. Still long range dependencies instead of small clusters.



